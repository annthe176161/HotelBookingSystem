@model HotelBookingSystem.ViewModels.Booking.BookingViewModel
@{
    ViewData["Title"] = "Đặt phòng";
}

@section Styles {
    <link rel="stylesheet" href="~/css/booking.css" />
}

<div class="container-fluid px-4 py-4">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 text-gray-800 mb-0">Đặt phòng</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
                            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Rooms")">Phòng</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Đặt phòng</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <!-- Booking Form -->
            <div class="card shadow">
                <div class="booking-form-container">
                    <!-- Progress Steps -->
                    <div class="booking-steps mb-4">
                        <div class="booking-step active">
                            <div class="step-number">1</div>
                            <div class="step-text">Thông tin đặt phòng</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="booking-step">
                            <div class="step-number">2</div>
                            <div class="step-text">Thanh toán</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="booking-step">
                            <div class="step-number">3</div>
                            <div class="step-text">Xác nhận</div>
                        </div>
                    </div>

                    <form method="post" asp-action="Create" asp-controller="Bookings">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-4"></div>
                        <input type="hidden" asp-for="RoomId" />

                        <!-- Stay Details Section -->
                        <div class="form-section mb-4">
                            <h3 class="section-title">Thông tin lưu trú</h3>

                            <div class="row mb-3">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label asp-for="CheckInDate" class="form-label">Ngày nhận phòng</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                        <input asp-for="CheckInDate" type="date" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="CheckInDate" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="CheckOutDate" class="form-label">Ngày trả phòng</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                        <input asp-for="CheckOutDate" type="date" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="CheckOutDate" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label asp-for="GuestCount" class="form-label">Số khách</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-users"></i></span>
                                        <select asp-for="GuestCount" class="form-select" required>
                                            <option value="">Chọn số khách</option>
                                            <option value="1">1 khách</option>
                                            <option value="2">2 khách</option>
                                            <option value="3">3 khách</option>
                                            <option value="4">4 khách</option>
                                            <option value="5">5 khách</option>
                                        </select>
                                    </div>
                                    <span asp-validation-for="GuestCount" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-12">
                                    <label asp-for="SpecialRequests" class="form-label">Yêu cầu đặc biệt</label>
                                    <textarea asp-for="SpecialRequests" class="form-control" rows="3" placeholder="Vui lòng cho chúng tôi biết nếu bạn có yêu cầu đặc biệt (không đảm bảo)"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Guest Information Section -->
                        <div class="form-section mb-4">
                            <h3 class="section-title">Thông tin khách hàng</h3>

                            <div class="row mb-3">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label asp-for="FirstName" class="form-label">Tên</label>
                                    <input asp-for="FirstName" type="text" class="form-control" required />
                                    <span asp-validation-for="FirstName" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="LastName" class="form-label">Họ</label>
                                    <input asp-for="LastName" type="text" class="form-control" required />
                                    <span asp-validation-for="LastName" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label asp-for="Email" class="form-label">Email</label>
                                    <div class="input-group">
                                        <span class="input-group-text">@@</span>
                                        <input asp-for="Email" type="email" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Phone" class="form-label">Số điện thoại</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                        <input asp-for="Phone" type="tel" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="Phone" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method Section -->
                        <div class="form-section mb-4">
                            <h3 class="section-title">Phương thức thanh toán</h3>

                            <div class="payment-methods">
                                <div class="payment-method-item active">
                                    <input type="radio" id="hotel-payment" name="PaymentMethod" value="Hotel" checked />
                                    <label for="hotel-payment" class="payment-method-label">
                                        <div class="payment-icon">
                                            <i class="fas fa-building"></i>
                                        </div>
                                        <div class="payment-info">
                                            <div class="payment-title">Thanh toán tại khách sạn</div>
                                            <div class="payment-description">Thanh toán trực tiếp tại quầy lễ tân khi nhận phòng</div>
                                        </div>
                                        <div class="payment-status">
                                            <span class="badge bg-success">Khuyến nghị</span>
                                        </div>
                                    </label>
                                </div>

                                <div class="payment-method-item disabled">
                                    <input type="radio" id="credit-card" name="PaymentMethod" value="CreditCard" disabled />
                                    <label for="credit-card" class="payment-method-label">
                                        <div class="payment-icon">
                                            <i class="fas fa-credit-card"></i>
                                        </div>
                                        <div class="payment-info">
                                            <div class="payment-title">Thẻ tín dụng</div>
                                            <div class="payment-description">Thanh toán bằng thẻ tín dụng (Sắp có)</div>
                                        </div>
                                        <div class="payment-status">
                                            <span class="badge bg-secondary">Sắp có</span>
                                        </div>
                                    </label>
                                </div>

                                <div class="payment-method-item disabled">
                                    <input type="radio" id="bank-transfer" name="PaymentMethod" value="BankTransfer" disabled />
                                    <label for="bank-transfer" class="payment-method-label">
                                        <div class="payment-icon">
                                            <i class="fas fa-university"></i>
                                        </div>
                                        <div class="payment-info">
                                            <div class="payment-title">Chuyển khoản ngân hàng</div>
                                            <div class="payment-description">Chuyển khoản qua ngân hàng (Sắp có)</div>
                                        </div>
                                        <div class="payment-status">
                                            <span class="badge bg-secondary">Sắp có</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="form-section mb-4">
                            <div class="terms-agreement">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="terms-agreement" required>
                                    <label class="form-check-label" for="terms-agreement">
                                        Tôi đồng ý với <a href="#" class="text-primary">Điều khoản và điều kiện</a> của khách sạn
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions text-end">
                            <a href="javascript:history.back()" class="btn btn-outline-secondary me-2">Quay lại</a>
                            <button type="submit" class="btn btn-primary">Hoàn tất đặt phòng</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Booking Summary -->
        <div class="col-lg-4">
            <div class="booking-summary card shadow">
                <div class="card-header">
                    <h5 class="mb-0">Tóm tắt đặt phòng</h5>
                </div>
                <div class="card-body">
                    <!-- Room Info -->
                    <div class="room-summary mb-4">
                        <div class="room-image mb-3">
                            <img src="@Model.RoomImageUrl" alt="@Model.RoomName" class="img-fluid rounded">
                        </div>
                        <h6 class="room-name">@Model.RoomName</h6>
                        <p class="room-type text-muted mb-0">@Model.RoomType</p>
                    </div>

                    <!-- Stay Details -->
                    <div class="stay-details mb-4">
                        <div class="detail-row">
                            <span class="detail-label">Ngày nhận phòng:</span>
                            <span class="detail-value" id="summary-checkin">Chưa chọn</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Ngày trả phòng:</span>
                            <span class="detail-value" id="summary-checkout">Chưa chọn</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Số đêm:</span>
                            <span class="detail-value" id="summary-nights">0</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Số khách:</span>
                            <span class="detail-value" id="summary-guests">Chưa chọn</span>
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="price-breakdown">
                        <div class="price-row">
                            <span class="price-label">Giá phòng/đêm:</span>
                            <span class="price-value">@Model.RoomPrice.ToString("C0")</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">Số đêm:</span>
                            <span class="price-value" id="summary-nights-price">0</span>
                        </div>
                        <hr>
                        <div class="price-row total-price">
                            <span class="price-label"><strong>Tổng cộng:</strong></span>
                            <span class="price-value"><strong id="summary-total">0đ</strong></span>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="contact-info mt-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>Có thắc mắc? Gọi <strong>(024) 3825 0888</strong> để được hỗ trợ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/booking.js"></script>
    <script>
        $(document).ready(function() {
            // Auto-fill dates and calculate price
            function updateSummary() {
                const checkinDate = $('#CheckInDate').val();
                const checkoutDate = $('#CheckOutDate').val();
                const guestCount = $('#GuestCount').val();
                
                $('#summary-checkin').text(checkinDate ? new Date(checkinDate).toLocaleDateString('vi-VN') : 'Chưa chọn');
                $('#summary-checkout').text(checkoutDate ? new Date(checkoutDate).toLocaleDateString('vi-VN') : 'Chưa chọn');
                $('#summary-guests').text(guestCount ? guestCount + ' khách' : 'Chưa chọn');
                
                if (checkinDate && checkoutDate) {
                    const nights = Math.floor((new Date(checkoutDate) - new Date(checkinDate)) / (1000 * 60 * 60 * 24));

                    if (nights > 0) {
                        $('#summary-nights').text(nights);
                        $('#summary-nights-price').text('x' + nights);

                        const pricePerNight = parseFloat('@Model.RoomPrice');
                        const totalPrice = pricePerNight * nights;
                        $('#summary-total').text(totalPrice.toLocaleString('vi-VN') + 'đ');
                    } else {
                        $('#summary-nights').text('0');
                        $('#summary-nights-price').text('x0');
                        $('#summary-total').text('0đ');
                    }
                } else {
                    $('#summary-nights').text('0');
                    $('#summary-nights-price').text('x0');
                    $('#summary-total').text('0đ');
                }
            }

            function initializeSummary() {
                updateSummary();
            }

            $('#CheckInDate, #CheckOutDate, #GuestCount').on('change', updateSummary);

            // Set minimum dates
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayString = today.toISOString().split('T')[0];
            $('#CheckInDate').attr('min', todayString);

            $('#CheckInDate').on('change', function() {
                const checkinDate = new Date(this.value);
                if (!isNaN(checkinDate.getTime())) {
                    const minCheckout = new Date(checkinDate);
                    minCheckout.setDate(checkinDate.getDate() + 1);
                    $('#CheckOutDate').attr('min', minCheckout.toISOString().split('T')[0]);

                    // Nếu ngày trả phòng hiện tại sớm hơn ngày nhận phòng mới, cập nhật nó
                    const currentCheckoutDate = new Date($('#CheckOutDate').val());
                    if (currentCheckoutDate < minCheckout) {
                        $('#CheckOutDate').val(minCheckout.toISOString().split('T')[0]);
                        $('#CheckOutDate').trigger('change'); // Kích hoạt sự kiện change để cập nhật lại summary
                    }
                }
            });

            // Initial calculation
            initializeSummary();
        });
    </script>
}
