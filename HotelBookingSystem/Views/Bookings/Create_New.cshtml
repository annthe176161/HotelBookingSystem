@model HotelBookingSystem.ViewModels.Booking.BookingViewModel
@{
    ViewData["Title"] = "Đặt phòng";
}

@section Styles {
    <link rel="stylesheet" href="~/css/booking-page.css" />
}

<div class="simple-booking-page">
    <div class="booking-container">
        <!-- Header -->
        <div class="booking-header">
            <h1><i class="fas fa-hotel me-3"></i>Đặt phòng khách sạn</h1>
            <p>Hoàn tất thông tin để đặt phòng @Model.RoomName</p>
        </div>

        <!-- Content -->
        <div class="booking-content">
            <div class="row">
                <!-- Main Form -->
                <div class="col-lg-8 col-xl-9">
                    <form asp-action="Create" method="post" novalidate>
                        <input type="hidden" asp-for="RoomId" />
                        <input type="hidden" asp-for="RoomName" />
                        <input type="hidden" asp-for="RoomType" />
                        <input type="hidden" asp-for="RoomImageUrl" />
                        <input type="hidden" asp-for="RoomPrice" />
                        <input type="hidden" asp-for="MaxGuests" />

                        <!-- Progress Indicator -->
                        <div class="booking-progress-container mb-4">
                            <div class="booking-progress-card">
                                <div class="progress-header text-center mb-3">
                                    <h5 class="mb-1">
                                        <i class="fas fa-tasks text-white me-2"></i>
                                        Tiến trình đặt phòng
                                    </h5>
                                    <small class="text-white-50">Hoàn thành thông tin để đặt phòng</small>
                                </div>
                                <div class="progress-steps">
                                    <div class="step-item active" data-step="1">
                                        <div class="step-circle">
                                            <i class="fas fa-calendar-check"></i>
                                        </div>
                                        <span class="step-label">Thông tin lưu trú</span>
                                    </div>
                                    <div class="step-connector"></div>
                                    <div class="step-item" data-step="2">
                                        <div class="step-circle">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <span class="step-label">Thông tin khách hàng</span>
                                    </div>
                                    <div class="step-connector"></div>
                                    <div class="step-item" data-step="3">
                                        <div class="step-circle">
                                            <i class="fas fa-credit-card"></i>
                                        </div>
                                        <span class="step-label">Thanh toán</span>
                                    </div>
                                    <div class="step-connector"></div>
                                    <div class="step-item" data-step="4">
                                        <div class="step-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <span class="step-label">Hoàn tất</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Thông tin lưu trú -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-calendar-check text-primary"></i>
                                Thông tin lưu trú
                            </h3>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="CheckInDate" class="form-label">Ngày nhận phòng</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                        <input asp-for="CheckInDate" type="date" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="CheckInDate" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="CheckOutDate" class="form-label">Ngày trả phòng</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                        <input asp-for="CheckOutDate" type="date" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="CheckOutDate" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="GuestCount" class="form-label">Số khách</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-users"></i></span>
                                        <select asp-for="GuestCount" class="form-select" required>
                                            <option value="">Chọn số khách</option>
                                            @for (int i = 1; i <= Model.MaxGuests; i++)
                                            {
                                                <option value="@i" selected="@(Model.GuestCount == i ? "selected" : null)">@i khách</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle text-primary"></i>
                                        Phòng này có thể chứa tối đa @Model.MaxGuests khách
                                    </div>
                                    <span asp-validation-for="GuestCount" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="SpecialRequests" class="form-label">Yêu cầu đặc biệt (tùy chọn)</label>
                                    <textarea asp-for="SpecialRequests" class="form-control" rows="3" placeholder="VD: Phòng tầng cao, giường đôi, gần thang máy..."></textarea>
                                    <span asp-validation-for="SpecialRequests" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Thông tin khách hàng -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-user text-primary"></i>
                                Thông tin khách hàng
                            </h3>

                            <!-- Thông báo về việc chỉnh sửa thông tin -->
                            <div class="alert alert-info d-flex align-items-center" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>
                                    <strong>Thông tin cá nhân:</strong> Thông tin này được lấy từ hồ sơ của bạn. 
                                    <a href="@Url.Action("Profile", "Account")" class="alert-link" target="_blank">
                                        <i class="fas fa-edit"></i> Cập nhật thông tin cá nhân
                                    </a>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="FirstName" class="form-label">Tên</label>
                                    <input asp-for="FirstName" type="text" class="form-control bg-light" readonly />
                                    <span asp-validation-for="FirstName" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="LastName" class="form-label">Họ</label>
                                    <input asp-for="LastName" type="text" class="form-control bg-light" readonly />
                                    <span asp-validation-for="LastName" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="Email" class="form-label">Email</label>
                                    <div class="input-group">
                                        <span class="input-group-text">@@</span>
                                        <input asp-for="Email" type="email" class="form-control bg-light" readonly />
                                    </div>
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="Phone" class="form-label">Số điện thoại</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                        <input asp-for="Phone" type="tel" class="form-control bg-light" readonly />
                                    </div>
                                    <span asp-validation-for="Phone" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Phương thức thanh toán -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-credit-card text-primary"></i>
                                Phương thức thanh toán
                            </h3>

                            <div class="payment-methods">
                                <div class="payment-method active">
                                    <input type="radio" id="hotel-payment" name="PaymentMethod" value="Hotel" checked style="display: none;" />
                                    <label for="hotel-payment" style="cursor: pointer; display: flex; align-items: center; gap: 15px; width: 100%; margin: 0;">
                                        <div class="payment-icon">
                                            <i class="fas fa-building"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-1">Thanh toán tại khách sạn</h5>
                                            <p class="mb-0 text-muted">Thanh toán trực tiếp khi nhận phòng</p>
                                            <small class="text-success"><i class="fas fa-check-circle"></i> Được khuyến nghị</small>
                                        </div>
                                    </label>
                                </div>
                                <div class="payment-method">
                                    <input type="radio" id="online-payment" name="PaymentMethod" value="Online" style="display: none;" />
                                    <label for="online-payment" style="cursor: pointer; display: flex; align-items: center; gap: 15px; width: 100%; margin: 0;">
                                        <div class="payment-icon">
                                            <i class="fas fa-globe"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-1">Thanh toán trực tuyến</h5>
                                            <p class="mb-0 text-muted">Thẻ tín dụng/ghi nợ, ví điện tử</p>
                                            <span class="badge bg-secondary ms-auto">Sắp có</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Điều khoản -->
                        <div class="form-section">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="terms-agreement" required>
                                <label class="form-check-label" for="terms-agreement">
                                    Tôi đồng ý với <a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#termsModal">Điều khoản và điều kiện</a> của khách sạn
                                </label>
                            </div>
                        </div>

                        <!-- Nút hành động -->
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="javascript:history.back()" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Quay lại
                            </a>
                            <button type="submit" class="btn-submit">
                                <i class="fas fa-check"></i>
                                Hoàn tất đặt phòng
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Sidebar - Tóm tắt đặt phòng -->
                <div class="col-lg-4 col-xl-3">
                    <div class="booking-summary">
                        <h5 class="summary-title">Tóm tắt đặt phòng</h5>
                        
                        <!-- Thông tin phòng -->
                        <div class="room-preview">
                            <img src="@Model.RoomImageUrl" alt="@Model.RoomName" class="img-fluid">
                            <h6 class="room-name">@Model.RoomName</h6>
                            <p class="room-type">@Model.RoomType</p>
                        </div>

                        <!-- Chi tiết đặt phòng -->
                        <div class="summary-details">
                            <div class="summary-row">
                                <span>Ngày nhận phòng:</span>
                                <span id="summary-checkin">Chưa chọn</span>
                            </div>
                            <div class="summary-row">
                                <span>Ngày trả phòng:</span>
                                <span id="summary-checkout">Chưa chọn</span>
                            </div>
                            <div class="summary-row">
                                <span>Số đêm:</span>
                                <span id="summary-nights">0</span>
                            </div>
                            <div class="summary-row">
                                <span>Số khách:</span>
                                <span id="summary-guests">Chưa chọn</span>
                            </div>
                            <div class="summary-row">
                                <span>Giá phòng/đêm:</span>
                                <span>@Model.RoomPrice.ToString("N0") VNĐ</span>
                            </div>
                            <div class="summary-row">
                                <span><strong>Tổng cộng:</strong></span>
                                <span><strong id="summary-total">0 VNĐ</strong></span>
                            </div>
                        </div>

                        <!-- Hỗ trợ khách hàng -->
                        <div class="contact-support">
                            <i class="fas fa-headset text-primary mb-2" style="font-size: 24px;"></i>
                            <p class="mb-1">Cần hỗ trợ?</p>
                            <p class="phone">Hotline: 1900 1234</p>
                            <div class="support-hours">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> 24/7 - Hỗ trợ mọi lúc
                                </small>
                            </div>
                        </div>

                        <!-- Thông tin hữu ích -->
                        <div class="helpful-info-card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle text-white me-2"></i>
                                    Thông tin hữu ích
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    <div class="info-card">
                                        <div class="info-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="info-content">
                                            <h6>Giờ nhận/trả phòng</h6>
                                            <p class="mb-1"><strong>Nhận:</strong> 14:00 - 23:00</p>
                                            <p class="mb-0"><strong>Trả:</strong> 06:00 - 12:00</p>
                                        </div>
                                    </div>
                                    
                                    <div class="info-card wifi">
                                        <div class="info-icon wifi">
                                            <i class="fas fa-wifi"></i>
                                        </div>
                                        <div class="info-content">
                                            <h6>WiFi miễn phí</h6>
                                            <p class="mb-0">Tốc độ cao trong toàn bộ khách sạn</p>
                                        </div>
                                    </div>
                                    
                                    <div class="info-card parking">
                                        <div class="info-icon parking">
                                            <i class="fas fa-car"></i>
                                        </div>
                                        <div class="info-content">
                                            <h6>Đỗ xe miễn phí</h6>
                                            <p class="mb-0">Bãi đỗ xe an toàn 24/7</p>
                                        </div>
                                    </div>
                                    
                                    <div class="info-card breakfast">
                                        <div class="info-icon breakfast">
                                            <i class="fas fa-utensils"></i>
                                        </div>
                                        <div class="info-content">
                                            <h6>Ưu đãi bữa sáng</h6>
                                            <p class="mb-0">Giảm 20% cho khách lưu trú</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chính sách hủy phòng -->
                        <div class="cancellation-policy-card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-times text-white me-2"></i>
                                    Chính sách hủy phòng
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="policy-list">
                                    <div class="policy-item-card success">
                                        <div class="policy-icon">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div class="policy-text">
                                            <strong>Hủy miễn phí</strong>
                                            <span>trước 24 giờ</span>
                                        </div>
                                    </div>
                                    <div class="policy-item-card warning">
                                        <div class="policy-icon">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <div class="policy-text">
                                            <strong>Phí 50%</strong>
                                            <span>hủy trong 24 giờ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal điều khoản và điều kiện -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">
                    <i class="fas fa-file-contract text-primary me-2"></i>
                    Điều khoản và điều kiện
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="terms-content">
                    <h6 class="text-primary">1. Điều khoản đặt phòng</h6>
                    <ul>
                        <li>Khách hàng phải từ 18 tuổi trở lên để thực hiện đặt phòng</li>
                        <li>Thông tin đặt phòng phải chính xác và đầy đủ</li>
                        <li>Việc đặt phòng chỉ được xác nhận sau khi thanh toán thành công</li>
                    </ul>

                    <h6 class="text-primary">2. Chính sách thanh toán</h6>
                    <ul>
                        <li>Thanh toán trực tiếp tại khách sạn khi nhận phòng</li>
                        <li>Chấp nhận các hình thức: Tiền mặt, thẻ tín dụng/ghi nợ</li>
                        <li>Giá phòng đã bao gồm VAT và phí dịch vụ</li>
                    </ul>

                    <h6 class="text-primary">3. Chính sách hủy và thay đổi</h6>
                    <ul>
                        <li>Hủy miễn phí trước 24 giờ so với thời gian nhận phòng</li>
                        <li>Hủy trong vòng 24 giờ sẽ tính phí 50% giá trị đặt phòng</li>
                        <li>Không xuất hiện (No-show) sẽ tính 100% giá trị đặt phòng</li>
                    </ul>

                    <h6 class="text-primary">4. Chính sách nhận và trả phòng</h6>
                    <ul>
                        <li>Thời gian nhận phòng: 14:00 - 23:00</li>
                        <li>Thời gian trả phòng: 06:00 - 12:00</li>
                        <li>Trả phòng muộn có thể phát sinh phí bổ sung</li>
                    </ul>

                    <h6 class="text-primary">5. Quy định chung</h6>
                    <ul>
                        <li>Không hút thuốc trong phòng</li>
                        <li>Không mang theo vật nuôi</li>
                        <li>Giữ trật tự và không làm ồn sau 22:00</li>
                        <li>Khách sạn có quyền từ chối phục vụ nếu vi phạm quy định</li>
                    </ul>

                    <h6 class="text-primary">6. Trách nhiệm và bồi thường</h6>
                    <ul>
                        <li>Khách hàng chịu trách nhiệm bồi thường thiệt hại do mình gây ra</li>
                        <li>Khách sạn không chịu trách nhiệm về tài sản cá nhân của khách</li>
                        <li>Sử dụng két sắt để bảo quản tài sản có giá trị</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="acceptTerms()" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>Tôi đồng ý
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Cập nhật tóm tắt đặt phòng
            function updateSummary() {
                const checkinDate = $('#CheckInDate').val();
                const checkoutDate = $('#CheckOutDate').val();
                const guestCount = $('#GuestCount').val();
                
                // Cập nhật ngày
                $('#summary-checkin').text(checkinDate ? new Date(checkinDate).toLocaleDateString('vi-VN') : 'Chưa chọn');
                $('#summary-checkout').text(checkoutDate ? new Date(checkoutDate).toLocaleDateString('vi-VN') : 'Chưa chọn');
                $('#summary-guests').text(guestCount ? guestCount + ' khách' : 'Chưa chọn');
                
                // Tính toán số đêm và tổng tiền
                if (checkinDate && checkoutDate) {
                    const nights = Math.floor((new Date(checkoutDate) - new Date(checkinDate)) / (1000 * 60 * 60 * 24));
                    if (nights > 0) {
                        $('#summary-nights').text(nights);
                        const pricePerNight = parseFloat('@Model.RoomPrice');
                        const totalPrice = pricePerNight * nights;
                        $('#summary-total').text(totalPrice.toLocaleString('vi-VN') + ' VNĐ');
                        
                        // Hiện thông báo tiết kiệm nếu ở nhiều đêm
                        if (nights >= 3) {
                            showDiscountNotification(nights);
                        }
                    } else {
                        $('#summary-nights').text('0');
                        $('#summary-total').text('0 VNĐ');
                    }
                } else {
                    $('#summary-nights').text('0');
                    $('#summary-total').text('0 VNĐ');
                }
            }

            // Hiển thị thông báo ưu đãi cho khách ở lâu
            function showDiscountNotification(nights) {
                if (!$('.discount-notification').length) {
                    const notification = `
                        <div class="discount-notification alert alert-success mt-2" role="alert">
                            <i class="fas fa-gift text-success me-2"></i>
                            <strong>Ưu đãi đặc biệt!</strong> Ở ${nights} đêm - Tặng kèm bữa sáng miễn phí!
                        </div>
                    `;
                    $('.booking-summary').append(notification);
                }
            }

            // Kiểm tra tình trạng phòng theo thời gian thực
            function checkRoomAvailability() {
                const checkinDate = $('#CheckInDate').val();
                const checkoutDate = $('#CheckOutDate').val();
                
                if (checkinDate && checkoutDate) {
                    // Giả lập kiểm tra tình trạng phòng
                    $('.availability-status').remove();
                    const statusHtml = `
                        <div class="availability-status alert alert-success mt-2" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            Phòng có sẵn trong thời gian này
                        </div>
                    `;
                    $('.booking-summary').append(statusHtml);
                }
            }

            // Ràng buộc ngày
            const today = new Date().toISOString().split('T')[0];
            $('#CheckInDate').attr('min', today);
            
            $('#CheckInDate').on('change', function() {
                const checkinDate = new Date(this.value);
                const minCheckout = new Date(checkinDate);
                minCheckout.setDate(checkinDate.getDate() + 1);
                $('#CheckOutDate').attr('min', minCheckout.toISOString().split('T')[0]);
                
                // Nếu ngày checkout nhỏ hơn minimum, reset
                const currentCheckout = new Date($('#CheckOutDate').val());
                if (currentCheckout <= checkinDate) {
                    $('#CheckOutDate').val('');
                }
                updateSummary();
                checkRoomAvailability();
            });

            // Event listeners
            $('#CheckInDate, #CheckOutDate, #GuestCount').on('change', function() {
                updateSummary();
                checkRoomAvailability();
            });
            
            // Validation form với thông báo chi tiết
            $('form').on('submit', function(e) {
                const checkinDate = $('#CheckInDate').val();
                const checkoutDate = $('#CheckOutDate').val();
                const guestCount = $('#GuestCount').val();
                const termsAccepted = $('#terms-agreement').is(':checked');
                
                if (!checkinDate || !checkoutDate) {
                    e.preventDefault();
                    showAlert('Vui lòng chọn ngày nhận phòng và trả phòng', 'warning');
                    return false;
                }
                
                if (!guestCount) {
                    e.preventDefault();
                    showAlert('Vui lòng chọn số khách', 'warning');
                    return false;
                }
                
                if (!termsAccepted) {
                    e.preventDefault();
                    showAlert('Vui lòng đồng ý với điều khoản và điều kiện', 'warning');
                    return false;
                }
                
                const nights = Math.floor((new Date(checkoutDate) - new Date(checkinDate)) / (1000 * 60 * 60 * 24));
                if (nights <= 0) {
                    e.preventDefault();
                    showAlert('Ngày trả phòng phải sau ngày nhận phòng', 'danger');
                    return false;
                }

                // Hiện loading spinner khi submit
                const submitBtn = $('button[type="submit"]');
                submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...');
                submitBtn.prop('disabled', true);
            });
            
            // Payment method selection
            $('.payment-method input[type="radio"]').on('change', function() {
                $('.payment-method').removeClass('active');
                $(this).closest('.payment-method').addClass('active');
            });

            // Animation cho form sections
            $('.form-section').each(function(index) {
                $(this).css('animation-delay', (index * 0.1) + 's').addClass('fade-in');
            });
            
            // Initial setup
            updateSummary();
            checkRoomAvailability();
        });

        // Function để chấp nhận điều khoản từ modal
        function acceptTerms() {
            $('#terms-agreement').prop('checked', true);
            showAlert('Đã chấp nhận điều khoản và điều kiện', 'success');
        }

        // Function hiển thị thông báo
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            $('body').append(alertHtml);
            
            // Auto remove after 5 seconds
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }

        // Keyboard shortcuts
        $(document).keydown(function(e) {
            // Ctrl/Cmd + Enter để submit form
            if ((e.ctrlKey || e.metaKey) && e.which === 13) {
                if ($('#terms-agreement').is(':checked')) {
                    $('form').submit();
                } else {
                    showAlert('Vui lòng đồng ý với điều khoản trước khi đặt phòng', 'warning');
                }
            }
        });
    </script>
}
