@model HotelBookingSystem.ViewModels.Admin.BookingsViewModel
@{
    ViewData["Title"] = "Quản lý đặt phòng";
    Layout = "_AdminLayout";
}

<div class="admin-bookings">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="d-flex align-items-center justify-content-between">
            <h1 class="h3 mb-0">Quản lý đặt phòng</h1>
        </div>
    </div>

    <!-- Booking Status Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card status-card h-100 pending">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="status-title">Chờ xác nhận</h6>
                        <h3 class="status-value">@Model.Pending</h3>
                    </div>
                    <div class="status-icon">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="?Status=Chờ%20xác%20nhận" class="view-all-link">Xem tất cả <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card status-card h-100 confirmed">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="status-title">Đã xác nhận</h6>
                        <h3 class="status-value">@Model.Confirmed</h3>
                    </div>
                    <div class="status-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="?Status=Đã%20xác%20nhận" class="view-all-link">Xem tất cả <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card status-card h-100 completed">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="status-title">Hoàn thành</h6>
                        <h3 class="status-value">@Model.Completed</h3>
                    </div>
                    <div class="status-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="?Status=Hoàn%20thành" class="view-all-link">Xem tất cả <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card status-card h-100 cancelled">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="status-title">Đã hủy</h6>
                        <h3 class="status-value">@Model.Cancelled</h3>
                    </div>
                    <div class="status-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="?Status=Đã%20hủy" class="view-all-link">Xem tất cả <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Filter Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="bookingSearchForm" class="booking-search-form" method="get">
                <div class="row g-3">
                    <div class="col-lg-2 col-md-4">
                        <input type="text" class="form-control" placeholder="Mã đặt phòng" name="BookingId" value="@Model.Query.BookingId">
                    </div>
                    <div class="col-lg-3 col-md-4">
                        <input type="text" class="form-control" placeholder="Tên khách hàng" name="CustomerName" value="@Model.Query.CustomerName">
                    </div>
                    <div class="col-lg-2 col-md-4">
                        <select class="form-select" name="Status">
                            <option value="">Tất cả trạng thái</option>
                            <option value="pending" selected="@(Model.Query.Status == "pending" ? "selected" : null)">Chờ xác nhận</option>
                            <option value="confirmed" selected="@(Model.Query.Status == "confirmed" ? "selected" : null)">Đã xác nhận</option>
                            <option value="completed" selected="@(Model.Query.Status == "completed" ? "selected" : null)">Hoàn thành</option>
                            <option value="cancelled" selected="@(Model.Query.Status == "cancelled" ? "selected" : null)">Đã hủy</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-4">
                        <input type="date" class="form-control" name="StartDate" value="@(Model.Query.StartDate?.ToString("yyyy-MM-dd"))">
                    </div>
                    <div class="col-lg-2 col-md-4">
                        <input type="date" class="form-control" name="EndDate" value="@(Model.Query.EndDate?.ToString("yyyy-MM-dd"))">
                    </div>
                    <div class="col-lg-1 col-md-4">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Bookings Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Danh sách đặt phòng</h5>
            <div class="d-flex">
                <div class="dropdown me-2">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-download me-1"></i> Xuất
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
                        <li><a class="dropdown-item" href="#"><i class="far fa-file-excel me-2"></i>Excel</a></li>
                        <li><a class="dropdown-item" href="#"><i class="far fa-file-pdf me-2"></i>PDF</a></li>
                        <li><a class="dropdown-item" href="#"><i class="far fa-file-csv me-2"></i>CSV</a></li>
                    </ul>
                </div>
                <a asp-action="Bookings" asp-controller="Admin" class="btn btn-sm btn-outline-secondary" title="Làm mới">
                    <i class="fas fa-sync-alt"></i>
                </a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col"><input class="form-check-input" type="checkbox" id="selectAll"></th>
                            <th scope="col">Mã đặt</th>
                            <th scope="col">Khách hàng</th>
                            <th scope="col">Phòng</th>
                            <th scope="col">Nhận phòng</th>
                            <th scope="col">Trả phòng</th>
                            <th scope="col">Số người</th>
                            <th scope="col">Tổng tiền</th>
                            <th scope="col">Trạng thái</th>
                            <th scope="col">Thanh toán</th>
                            <th scope="col">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var booking in Model.Bookings)
                        {
                            <tr>
                                <td><input class="form-check-input" type="checkbox"></td>
                                <td><a href="#" class="booking-link">@booking.Id</a></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle me-2">
                                            <span>@(string.Join("", booking.CustomerName.Split(' ').Select(x => x[0])))</span>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">@booking.CustomerName</h6>
                                            <small class="text-muted">@booking.CustomerEmail</small>
                                        </div>
                                    </div>
                                </td>
                                <td>@booking.RoomName</td>
                                <td>@booking.CheckIn.ToString("dd/MM/yyyy")</td>
                                <td>@booking.CheckOut.ToString("dd/MM/yyyy")</td>
                                <td>@booking.Guests</td>
                                <td>@booking.TotalPrice.ToString("N0") VNĐ</td>
                                <td>
                                    <span class="badge @(booking.BookingStatus switch {
                                        "Chờ xác nhận" => "bg-warning text-dark",
                                        "Đã xác nhận" => "bg-primary text-white",
                                        "Hoàn thành" => "bg-success text-white",
                                        "Đã hủy" => "bg-danger text-white",
                                        _ => "bg-secondary"
                                    })">
                                        @booking.BookingStatus
                                    </span>
                                </td>
                                <td><span class="badge @(booking.PaymentStatus switch {
                                        "Đang xử lý" => "bg-warning text-dark",
                                        "Thành công" => "bg-success text-white",
                                        "Thất bại" => "bg-danger text-white",
                                        "Đã hoàn tiền" => "bg-danger text-white",
                                        _ => "bg-secondary"
                                    })">@booking.PaymentStatus</span></td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm action-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <!-- Always show "Chi tiết" -->
                                            <li>
                                                <a class="dropdown-item" asp-action="BookingDetails" asp-controller="Admin" asp-route-id="@booking.Id">
                                                    <i class="fas fa-eye me-2"></i>Chi tiết
                                                </a>
                                            </li>

                                            <!-- Booking Status Section -->
                                            @if (booking.BookingStatus != "Hoàn thành" && booking.BookingStatus != "Đã hủy")
                                            {
                                                <li><hr class="dropdown-divider"></li>
                                                <li class="dropdown-header"><i class="fas fa-calendar-alt me-1"></i>Trạng thái đặt phòng</li>
                                                
                                                @if (booking.BookingStatus == "Chờ xác nhận")
                                                {
                                                    <li>
                                                        <form asp-action="UpdateBookingStatus" asp-controller="Admin" method="post" class="d-inline">
                                                            <input type="hidden" name="id" value="@booking.Id" />
                                                            <input type="hidden" name="status" value="Đã xác nhận" />
                                                            <button type="submit" class="dropdown-item">
                                                                <i class="fas fa-check me-2 text-success"></i>Xác nhận đặt phòng
                                                            </button>
                                                        </form>
                                                    </li>
                                                }
                                                
                                                @if (booking.BookingStatus == "Đã xác nhận")
                                                {
                                                    <li>
                                                        <form asp-action="UpdateBookingStatus" asp-controller="Admin" method="post" class="d-inline">
                                                            <input type="hidden" name="id" value="@booking.Id" />
                                                            <input type="hidden" name="status" value="Hoàn thành" />
                                                            <button type="submit" class="dropdown-item" 
                                                                    onclick="return confirm('⚠️ XÁC NHẬN HOÀN THÀNH ĐẶT PHÒNG\n\nBạn có chắc chắn rằng:\n✅ Khách hàng đã check-out thành công\n✅ Khách hàng đã thanh toán đầy đủ\n\nSau khi xác nhận, trạng thái thanh toán sẽ tự động chuyển thành \'Thành công\'')">
                                                                <i class="fas fa-flag-checkered me-2 text-primary"></i>Hoàn thành đặt phòng
                                                                <small class="text-muted d-block ms-3">Tự động cập nhật thanh toán thành công</small>
                                                            </button>
                                                        </form>
                                                    </li>
                                                }
                                                
                                                <li>
                                                    <button type="button" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#cancelModal" 
                                                            data-booking-id="@booking.Id" data-customer-name="@booking.CustomerName">
                                                        <i class="fas fa-times me-2"></i>Hủy đặt phòng
                                                    </button>
                                                </li>
                                            }

                                            <!-- Payment Status Section -->
                                            @if (booking.BookingStatus != "Đã hủy" && booking.BookingStatus != "Hoàn thành")
                                            {
                                                <li><hr class="dropdown-divider"></li>
                                                <li class="dropdown-header"><i class="fas fa-credit-card me-1"></i>Trạng thái thanh toán</li>
                                                
                                                @* Chỉ cho phép xác nhận thanh toán khi booking đã hoàn thành *@
                                                @if (booking.PaymentStatus == "Đang xử lý" && booking.BookingStatus == "Hoàn thành")
                                                {
                                                    <li>
                                                        <form asp-action="UpdatePaymentStatus" asp-controller="Admin" method="post" class="d-inline">
                                                            <input type="hidden" name="id" value="@booking.Id" />
                                                            <input type="hidden" name="paymentStatus" value="Thành công" />
                                                            <button type="submit" class="dropdown-item">
                                                                <i class="fas fa-check-circle me-2 text-success"></i>Xác nhận thanh toán
                                                            </button>
                                                        </form>
                                                    </li>
                                                }
                                                else if (booking.PaymentStatus == "Đang xử lý" && booking.BookingStatus != "Hoàn thành")
                                                {
                                                    <li>
                                                        <span class="dropdown-item text-muted">
                                                            <i class="fas fa-info-circle me-2"></i>Xác nhận thanh toán sau khi hoàn thành booking
                                                        </span>
                                                    </li>
                                                }
                                            }
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="card-footer d-flex justify-content-between align-items-center">
            <div class="pagination-info">
                Hiển thị <span>@((Model.CurrentPage-1)*Model.Query.PageSize+1)</span> đến 
                <span>@(Math.Min(Model.CurrentPage*Model.Query.PageSize, Model.TotalBookings))</span> của 
                <span>@Model.TotalBookings</span> mục
            </div>
            <ul class="pagination mb-0">
                <li class="page-item @(Model.CurrentPage==1?"disabled":"")">
                    <a class="page-link" href="?Page=@(Model.CurrentPage-1)"><i class="fas fa-angle-left"></i></a>
                </li>
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(Model.CurrentPage==i?"active":"")">
                        <a class="page-link" href="?Page=@i">@i</a>
                    </li>
                }
                <li class="page-item @(Model.CurrentPage==Model.TotalPages?"disabled":"")">
                    <a class="page-link" href="?Page=@(Model.CurrentPage+1)"><i class="fas fa-angle-right"></i></a>
                </li>
            </ul>
            <div class="items-per-page">
                <select class="form-select form-select-sm" onchange="location = '?PageSize=' + this.value;">
                    <option value="10" selected="@(Model.Query.PageSize == 10 ? "selected" : null)">10 / trang</option>
                    <option value="25" selected="@(Model.Query.PageSize == 25 ? "selected" : null)">25 / trang</option>
                    <option value="50" selected="@(Model.Query.PageSize == 50 ? "selected" : null)">50 / trang</option>
                    <option value="100" selected="@(Model.Query.PageSize == 100 ? "selected" : null)">100 / trang</option>
                </select>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="~/css/admin-bookings.css" asp-append-version="true" />
    <style>
        .admin-bookings .dropdown-menu {
            z-index: 1055 !important;
        }
        
        /* Enhanced dropdown styling */
        .dropdown-header {
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 4px 0;
        }
        
        .dropdown-item.disabled {
            color: #6c757d;
            pointer-events: none;
            background-color: transparent;
        }
        
        .dropdown-item.disabled:hover {
            background-color: transparent;
        }
        
        .dropdown-item small {
            font-size: 11px;
        }
        
        /* Different colors for different actions */
        .dropdown-item:has(.text-success):hover {
            background-color: #d4edda;
        }
        
        .dropdown-item:has(.text-danger):hover {
            background-color: #f8d7da;
        }
        
        .dropdown-item:has(.text-warning):hover {
            background-color: #fff3cd;
        }
        
        .dropdown-item:has(.text-primary):hover {
            background-color: #cce7ff;
        }
    </style>
}

<!-- Modal hủy đặt phòng -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">
                    <i class="fas fa-times text-danger me-2"></i>Hủy đặt phòng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="CancelBooking" asp-controller="Admin" method="post">
                <div class="modal-body">
                    <input type="hidden" id="cancelBookingId" name="id" value="" />
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Xác nhận hủy đặt phòng</strong>
                        <p class="mb-0 mt-2">Bạn đang hủy đặt phòng cho khách: <strong id="cancelCustomerName"></strong></p>
                        <p class="mb-0">Mã đặt phòng: <strong>#<span id="cancelBookingIdDisplay"></span></strong></p>
                    </div>

                    <div class="mb-3">
                        <label for="cancelReason" class="form-label">
                            <i class="fas fa-comment me-1"></i>Lý do hủy phòng <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="cancelReason" name="cancelReason" required>
                            <option value="">-- Chọn lý do hủy phòng --</option>
                            <option value="Khách sạn hết phòng">Khách sạn hết phòng</option>
                            <option value="Phòng bị hỏng đột xuất">Phòng bị hỏng đột xuất</option>
                            <option value="Khách vi phạm quy định">Khách vi phạm quy định</option>
                            <option value="Yêu cầu của khách hàng">Yêu cầu của khách hàng</option>
                            <option value="Lý do bất khả kháng">Lý do bất khả kháng</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>

                    <div class="mb-3" id="customReasonGroup" style="display: none;">
                        <label for="customReason" class="form-label">
                            <i class="fas fa-edit me-1"></i>Lý do cụ thể
                        </label>
                        <textarea class="form-control" id="customReason" name="customReason" rows="3" 
                                  placeholder="Nhập lý do hủy phòng cụ thể..."></textarea>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Lưu ý:</strong> Khách hàng sẽ nhận được thông báo về việc hủy phòng qua email.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Đóng
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check me-2"></i>Xác nhận hủy phòng
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Xử lý modal hủy đặt phòng
        document.addEventListener('DOMContentLoaded', function() {
            const cancelModal = document.getElementById('cancelModal');
            const cancelReason = document.getElementById('cancelReason');
            const customReasonGroup = document.getElementById('customReasonGroup');
            const customReason = document.getElementById('customReason');

            // Khi modal được mở
            cancelModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');
                const customerName = button.getAttribute('data-customer-name');

                document.getElementById('cancelBookingId').value = bookingId;
                document.getElementById('cancelBookingIdDisplay').textContent = bookingId;
                document.getElementById('cancelCustomerName').textContent = customerName;

                // Reset form
                cancelReason.value = '';
                customReason.value = '';
                customReasonGroup.style.display = 'none';
            });

            // Hiển thị/ẩn ô nhập lý do tùy chỉnh
            cancelReason.addEventListener('change', function() {
                if (this.value === 'Khác') {
                    customReasonGroup.style.display = 'block';
                    customReason.required = true;
                } else {
                    customReasonGroup.style.display = 'none';
                    customReason.required = false;
                }
            });

            // Xử lý submit form
            const cancelForm = document.querySelector('#cancelModal form');
            cancelForm.addEventListener('submit', function(e) {
                const reasonValue = cancelReason.value;
                let finalReason = reasonValue;

                if (reasonValue === 'Khác') {
                    finalReason = customReason.value.trim();
                    if (!finalReason) {
                        e.preventDefault();
                        alert('Vui lòng nhập lý do hủy phòng cụ thể.');
                        return;
                    }
                }

                if (!reasonValue) {
                    e.preventDefault();
                    alert('Vui lòng chọn lý do hủy phòng.');
                    return;
                }

                // Cập nhật giá trị cuối cùng
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'cancelReason';
                hiddenInput.value = finalReason;
                this.appendChild(hiddenInput);

                // Xác nhận cuối cùng
                if (!confirm(`Bạn có chắc muốn hủy đặt phòng này?\nLý do: ${finalReason}`)) {
                    e.preventDefault();
                }
            });
        });
    </script>
}